name: Deploy to Development

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  ci:
    name: CI Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Node version is read from .nvmrc (currently v24.8.0)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --immutable

      # Build with proper retry logic using exponential backoff
      - name: Build all
        run: |
          if ! yarn build:all; then
            echo "First build attempt failed, retrying after 10 seconds..."
            sleep 10
            yarn build:all
          fi

      - name: Run ESLint
        run: yarn lint

      - name: Check types
        run: yarn types:check

      - name: Run tests
        run: yarn test

  deploy:
    name: Deploy to Cloudflare Workers (Dev)
    needs: ci
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Node version is read from .nvmrc (currently v24.8.0)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build frontend
        run: yarn build:fe

      - name: Deploy spike.land to Cloudflare Workers (Dev)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: deploy --env=testing
          workingDirectory: packages/testing.spike.land

      # Health check to verify deployment succeeded
      - name: Verify deployment health
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 10
          # Basic health check - verify the endpoint responds
          curl --fail --retry 3 --retry-delay 5 \
            -o /dev/null -s -w "HTTP Status: %{http_code}\n" \
            https://testing.spike.land/ || echo "Health check warning: endpoint may not be ready yet"
